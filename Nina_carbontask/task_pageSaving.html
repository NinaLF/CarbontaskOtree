

{% block styles %}
    <link href="{{ static 'global/css/generalStyle.css'}}" rel="stylesheet">
    <link href="{{ static 'global/css/customStyle.css'}}" rel="stylesheet">
{% endblock %}

{{ block title }} 
Please rate these 
{{ endblock }}
{{ block content }}
<meta charset="UTF-8">


<style>

/* Adjust the max-width as needed */
    @media only screen and (min-width: 701px) {
        .radiotable {
            width: 60%;
            padding: 20px 20px; 
            font-weight: normal;
        }
    }

    @media only screen and (max-width: 700px) {
        .radiotable {
            width: 100%;
            padding: 30px 40px; 
            font-weight: normal;
        }
    }
    /* Adjust spacing between sentences */
    .sentence {
        margin: 0;
        /* Adjust this value to control spacing between sentences */
        padding: 0;
        /* Optionally adjust padding if needed */
        line-height: 0.5;
    }
    .question {
        margin: 0;
        /* Adjust this value to control spacing between sentences */
        padding: 0;
        /* Optionally adjust padding if needed */
        line-height: 0.5;
        size: 17
    }

    .info {
        margin: 0;
        /* Adjust this value to control spacing between sentences */
        padding: 0;
        /* Optionally adjust padding if needed */
        line-height: 0.2;
        size: 10
    }
   

    table, th, tr, td{
        border: 1px solid;
        border-left: none;
        border-right: none;
        font-weight: normal;
        padding: 30px 30px 20px 20px; 

    }

    td.image {
        width: 100px;
        padding: 8px;
    }
    

    td.type {
        width: 100px;
        padding: 12px;
        font-weight: normal;
    }



    .radiotable, tr, th, td{

        border: none;
        text-align: left;
        border: none;
        border-top: none;
        font-weight: normal;
    }

  /* Horizontal Slider styling */
    .slider-container {
        margin-top: 20px;
        width: 95%;
        position: relative;
    }

    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 15px;
        border-radius: 5px;
        background: #cacaca;
        outline: none;
        opacity: 0.7;
        transition: opacity 0.2s;
        position: relative;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #e8d13b;
        cursor: pointer;
        border-radius: 50%;
        position: relative;
        z-index: 1;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #e8d13b;
        cursor: pointer;
        border-radius: 50%;
        position: relative;
        z-index: 1;
    }

    .slider.inactive::-webkit-slider-thumb {
    visibility: hidden;
    }

    .slider.inactive::-moz-range-thumb {
        visibility: hidden;
    }
    .current-value.hidden { visibility: hidden; }

    .slider-labels {
        display: flex;
        justify-content: space-between;
        text-align: left;
        width: 100%;
    }
    .current-value {
        font-size: 16px;
        color: #000;
        margin-top: 10px;
        position: absolute;
        width: 100%;
        font-weight: normal;
        text-align: center;
    }

    /* Input field styling */
    .form-field-small {
        width: 80px; /* Adjust the width as needed */
        font-size: 16px; /* Optional: Adjust font size for readability */
        padding: 5px; /* Optional: Add padding for better appearance */
    }

   

    /* .image {
        width: 125px;
    } */
</style>

<p style="text-align: left; font-size: 0.9rem;">
    Round {{round_number}} out of 12
    <br>
</p>


<div class=".question" > 
    <p>
        <br>
        <b> Think about a person making the following behavior changes. How much emissions do you think this person saves over the course of an entire year? </b>

    <br>
</div>


<table id="currentFootprintTable">

</table>
<br>
<br>
<meta charset="UTF-8">

<div > 
    <p style=" font-size: 17px;"> Please <b>click on the slider and move to make your estimate</b> about the savings potential in tons of CO<sub>2eq</sub>. <br>
        The minimum and maximum represent the actual range of savings possible in this scenario, so <b>you can use the full range of the slider. </b> 
     </p>
    <input type="text" name="ratingSaving" class="form-field-small" style="background-color: white; border-color: white; color: white; background: transparent; border: none; color: transparent;" >

    <div class="slider-container">
        <div class="slider-labels">
            <span>0.00 <br> tons CO<sub>2</sub></span>
            <span>3.38 <br> tons CO<sub>2</sub></span>
        </div>
        <input type="range" min="0.00" max="3.38" step="0.02"  class="slider" id="carbonSlider">
        <div class="current-value" id="sliderValue"> </div>
    </div>
    {{ formfield_errors 'ratingSaving' }}
</div>




<div >
    <button id="nextst" style="float: right; margin-top: 2vh;" disabled class="otree-btn-next btn btn-primary"> Next </button>
 
</div>
{% endblock %}



{% block scripts %}
<meta charset="UTF-8">

<script>
    var currentBehaviors = "{{current_footprint_table |safe }}"
    currentBehaviors = eval(currentBehaviors)
    var currentImages = "{{current_footprint_table_images}}"
    currentImages = eval(currentImages)
    var behaviorTypes = "{{behaviorTYPES}}"
    behaviorTypes = eval(behaviorTypes)
    var random_behavior_order = '{{random_behavior_order}}'
    random_behavior_order = eval(random_behavior_order)
    var behaviorTypesDict = {}
    
    random_behavior_order.forEach((random_behavior_order, i) => behaviorTypesDict[random_behavior_order] = behaviorTypes[i]);
    console.log(behaviorTypesDict)
    
    function renderBehavior(td, html) {
        td.style.setProperty('font-weight', 'normal', 'important');
        td.textContent = '';
        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        const appendFrom = (node, isBold) => {
            node.childNodes.forEach(n => {
                if (n.nodeType === 3) {
                    const span = document.createElement('span');
                    span.textContent = n.nodeValue;
                    span.style.setProperty('font-weight', isBold ? 'bold' : 'normal', 'important');
                    td.appendChild(span);
                } else if (n.nodeType === 1) {
                    const tag = n.tagName.toLowerCase();
                    const nextBold = isBold || tag === '<b>' || tag === 'strong';
                    appendFrom(n, nextBold);
                }
            });
        };
        appendFrom(tmp, false);
    }


    fillTable = function () {
        console.log("hello istarted");

        for (let i = 0; i < currentBehaviors.length && i < currentImages.length; i++) {

            const thisCurrType = behaviorTypes[random_behavior_order[i]];
            const thisCurrBeh  = currentBehaviors[i];
            const thisCurrImg  = currentImages[i];

            const mytable = document.getElementById("currentFootprintTable");
            const row = mytable.insertRow(-1);
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            const cell3 = row.insertCell(2);

            cell1.textContent = thisCurrType;
            cell1.classList.add("type");

            cell2.innerHTML = thisCurrBeh;
            cell2.classList.add("behavior");

            (function(td, html) {
                td.textContent = '';
                td.style.setProperty('font-weight', '400', 'important');
                const parts = String(html).split(/(<\s*\/?\s*(?:b|strong)\s*>)/gi);
                let isBold = false;
                parts.forEach(part => {
                    const lower = part.toLowerCase().replace(/\s+/g, '');
                    if (lower === '<b>' || lower === '<strong>') {
                        isBold = true;
                    } else if (lower === '</b>' || lower === '</strong>') {
                        isBold = false;
                    } else if (part) {
                        const span = document.createElement('span');
                        span.textContent = part;
                        span.style.setProperty('font-weight', isBold ? '700' : '400', 'important');
                        td.appendChild(span);
                    }
                });
            })(cell2, thisCurrBeh);

            const imgString = `<img style="width:55%;" src="/static/global/images/${thisCurrImg}.png">`;
            cell3.innerHTML = imgString;
            cell3.classList.add("image");
        }
    };



    window.onload = function () {
        fillTable();  

        // -------------------------------
        // (1) NEW: simple wait flag
        // -------------------------------
        const nextBtn = document.getElementById('nextst');   // <<< NEW
        let waitOver = false;                                // <<< NEW

        // replace your enablebtn() call
        setTimeout(function () { waitOver = true; }, 1000);  // <<< CHANGED

        const formField   = document.querySelector('input[name="ratingSaving"]');
        const slider      = document.getElementById('carbonSlider');
        const sliderValue = document.getElementById('sliderValue');

        slider.classList.add('inactive');
        slider.dataset.activated = "false";
        sliderValue.classList.add('hidden');
        formField.value = "";

        function renderValue() {
            if (slider.dataset.activated === "true") {
                sliderValue.textContent = Number(slider.value).toFixed(2);
                sliderValue.classList.remove('hidden');
            } else {
                sliderValue.textContent = "";
                sliderValue.classList.add('hidden');
            }
        }

        function activateSlider() {
            if (slider.dataset.activated !== "true") {
                slider.dataset.activated = "true";
                slider.classList.remove('inactive');
            }
            renderValue();
            updateSliderColor(slider);
        }

        function setSliderValueFromEvent(e) {
            const rect = slider.getBoundingClientRect();
            const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
            const ratio = Math.min(1, Math.max(0, (clientX - rect.left) / rect.width));
            const min = parseFloat(slider.min), max = parseFloat(slider.max), step = parseFloat(slider.step) || 1;
            let val = min + ratio * (max - min);
            val = Math.round(val / step) * step;
            val = Math.min(max, Math.max(min, val));
            slider.value = val;
            slider.dispatchEvent(new Event('input', { bubbles: true }));
        }

        slider.addEventListener('mousedown', function (e) {
            if (slider.dataset.activated !== "true") {
                setSliderValueFromEvent(e);
                activateSlider();
            }
        });
        slider.addEventListener('touchstart', function (e) {
            if (slider.dataset.activated !== "true") {
                setSliderValueFromEvent(e);
                activateSlider();
            }
        }, { passive: true });

        // -----------------------------------
        // (2) NEW: enable button when slider moves AND wait is over
        // -----------------------------------
        slider.addEventListener('input', function() {
            formField.value = slider.value;
            activateSlider();

            if (waitOver) { 
                nextBtn.disabled = false;        // <<< NEW
            }
        });

        formField.addEventListener('input', function() {
            slider.value = formField.value;
            activateSlider();
        });

        updateSliderColor(slider);
    };

    function updateSliderColor(slider) {
        if (slider.classList.contains('inactive') || slider.dataset.activated !== "true") {
            slider.style.background = '#cacaca';
            return;
        }
        const value = (slider.value - slider.min) / (slider.max - slider.min);
        slider.style.background =
            `linear-gradient(to right, #e8d13b 0%, #e8d13b ${value * 100}%, #cacaca ${value * 100}%, #cacaca 100%)`;
    }
</script>


{{ endblock }}
